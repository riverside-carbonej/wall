<div class="map-view" [class.full-page]="fullPage">
  <!-- Map Controls -->
  @if (showControls) {
    <div class="map-controls">
    <div class="controls-row">
      <!-- Tile Provider Selector -->
      <mat-form-field appearance="outline" class="control-field">
        <mat-label>Map Type</mat-label>
        <mat-select 
          [value]="settings.tileProvider"
          (selectionChange)="onTileProviderChange($event.value)">
          <mat-option value="openstreetmap">
            <mat-icon>map</mat-icon>
            Street Map
          </mat-option>
          <mat-option value="satellite">
            <mat-icon>satellite_alt</mat-icon>
            Satellite
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <!-- Object Type Filter -->
      <mat-form-field appearance="outline" class="control-field">
        <mat-label>Filter by Type</mat-label>
        <mat-select 
          [value]="settings.showAllItems ? 'all' : settings.filterByObjectType"
          (selectionChange)="onFilterChange($event.value)">
          <mat-option value="all">
            <mat-icon>visibility</mat-icon>
            All Items ({{ getVisibleItemsCount() }})
          </mat-option>
          @for (objectType of objectTypes; track objectType.id) {
            <mat-option [value]="objectType.id">
              <mat-icon [style.color]="objectType.color">{{ objectType.icon || 'circle' }}</mat-icon>
              {{ objectType.name }} ({{ getItemCountForObjectType(objectType.id) }})
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
      <button 
        mat-outlined-button
        (click)="fitToAllMarkers()"
        [disabled]="getItemsWithCoordinatesCount() === 0"
        matTooltip="Zoom to fit all items">
        <mat-icon>zoom_out_map</mat-icon>
        Fit All
      </button>
      
      <button 
        mat-outlined-button
        (click)="refreshMap()"
        matTooltip="Refresh map">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
    </div>
  }
  
  <!-- Map Container -->
  <div class="map-container">
    <!-- Loading Overlay -->
    @if (isLoading) {
      <app-loading-state
        type="spinner"
        message="Loading map..."
        containerClass="overlay"
        [spinnerSize]="40">
      </app-loading-state>
    }
    
    <!-- Map -->
    <div 
      #mapContainer 
      id="map-view-map"
      [style.height]="fullPage ? '100%' : height"
      class="map">
    </div>
    
    <!-- No Items Message -->
    @if (!isLoading && getItemsWithCoordinatesCount() === 0) {
      <app-empty-state
        icon="location_off"
        title="No items with locations found"
        [message]="getVisibleItemsCount() === 0 ? 'No items match the current filter criteria.' : getVisibleItemsCount() + ' items found, but none have coordinate data. Add locations to your items to see them on the map.'"
        containerClass="overlay">
      </app-empty-state>
    }
    
    <!-- Map Stats -->
    @if (!isLoading && getItemsWithCoordinatesCount() > 0) {
      <div class="map-stats">
        <div class="stats-chip">
          <mat-icon>place</mat-icon>
          <span>{{ getItemsWithCoordinatesCount() }} items on map</span>
        </div>
      </div>
    }
  </div>
  
  <!-- Legend (if multiple object types visible) - hide in full page mode -->
  @if (!fullPage && objectTypes.length > 1 && !isLoading) {
    <div class="map-legend">
    <h4>Legend</h4>
    <div class="legend-items">
      @for (objectType of objectTypes; track objectType.id) {
        <div 
          class="legend-item" 
          [class.active]="settings.showAllItems || settings.filterByObjectType === objectType.id">
          <div class="legend-marker" [style.background-color]="objectType.color">
            <mat-icon>{{ objectType.icon || 'circle' }}</mat-icon>
          </div>
          <span class="legend-label">{{ objectType.name }}</span>
          <span class="legend-count">
            ({{ getItemCountForObjectType(objectType.id) }})
          </span>
        </div>
      }
    </div>
    </div>
  }
</div>