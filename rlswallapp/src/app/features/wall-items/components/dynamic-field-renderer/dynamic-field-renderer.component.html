<div class="dynamic-field-renderer">
  <!-- Read-only Display Mode -->
  @if (readonly) {
    <div class="readonly-field">
      <div class="field-label">
        {{ field.name }}
        @if (field.required) {
          <span class="required-indicator">*</span>
        }
      </div>
      
      <div class="field-value" [class.empty]="!formControl?.value">
        {{ getDisplayValue() || 'No value' }}
      </div>
      
      <!-- Special display for color fields -->
      @if (isColor() && formControl?.value) {
        <div class="color-preview">
          <div class="color-swatch" [style.background-color]="formControl?.value"></div>
        </div>
      }
      
    </div>
  }

  <!-- Edit Mode - Form Fields -->
  @if (!readonly && formGroup) {
    <div class="edit-field" [formGroup]="formGroup">
      
      <!-- Text Input Field -->
      @if (isText()) {
        <div class="form-field">
          <label class="field-label">
            {{ field.name }}
            @if (field.required) {
              <span class="required-indicator">*</span>
            }
          </label>
          <div class="input-container" [class.error]="formControl?.invalid && formControl?.touched">
            <textarea 
              class="material-textarea" 
              [formControl]="formControl"
              [placeholder]="field.placeholder || ''"
              [required]="field.required"
              rows="1"></textarea>
          </div>
          @if (formControl?.invalid && formControl?.touched) {
            <div class="field-error">
              <mat-icon [icon]="'error'"></mat-icon>
              {{ getErrorMessage() }}
            </div>
          }
        </div>
      }


      <!-- Date Input -->
      @if (isDate()) {
        <div class="form-field">
          <label class="field-label">
            {{ field.name }}
            @if (field.required) {
              <span class="required-indicator">*</span>
            }
          </label>
          <app-material-date-picker
            [value]="formControl?.value"
            (dateSelected)="onDateSelected($event)">
          </app-material-date-picker>
          @if (formControl?.invalid && formControl?.touched) {
            <div class="field-error">
              <mat-icon [icon]="'error'"></mat-icon>
              {{ getErrorMessage() }}
            </div>
          }
        </div>
      }


      <!-- Color Input -->
      @if (isColor()) {
        <div class="color-field">
          <app-form-field
            [label]="field.name"
            [required]="field.required"
            [suffixIcon]="'palette'"
            [error]="formControl?.invalid && formControl?.touched ? getErrorMessage() : undefined"
            appearance="outline"
            spacing="comfortable"
            class="color-input">
            <input 
              matInput 
              type="color"
              [formControl]="formControl"
              [required]="field.required">
          </app-form-field>
          <div class="color-preview">
            <div class="color-swatch" [style.background-color]="formControl?.value"></div>
          </div>
        </div>
      }

      <!-- Boolean/Checkbox Field -->
      @if (isBoolean()) {
        <div class="boolean-field">
          <div class="field-label">
            {{ field.name }}
            @if (field.required) {
              <span class="required-indicator">*</span>
            }
          </div>
          
          <app-material-switch
            [formControl]="formControl"
            [label]="field.placeholder || (field.required ? 'Required' : 'Optional')"
            [disabled]="readonly">
          </app-material-switch>
          
          @if (formControl?.invalid && formControl?.touched) {
            <div class="field-error">
              <mat-icon [icon]="'error'"></mat-icon>
              {{ getErrorMessage() }}
            </div>
          }
        </div>
      }


      <!-- Location Field -->
      @if (isLocation()) {
        <div class="location-field">
          <div class="field-label">
            {{ field.name }}
            @if (field.required) {
              <span class="required-indicator">*</span>
            }
          </div>
          
          <!-- Read-only Location Display -->
          @if (readonly) {
            <div class="location-display">
              @if (formControl?.value && formControl?.value.address) {
                <div class="address-primary">
                  <mat-icon>location_on</mat-icon>
                  <span>{{ formControl?.value.address }}</span>
                </div>
              }
              @if (formControl?.value && formControl?.value.lat && formControl?.value.lng && !formControl?.value.address) {
                <div class="coordinates-fallback">
                  <mat-icon>place</mat-icon>
                  <span>{{ formControl?.value.lat.toFixed(4) }}, {{ formControl?.value.lng.toFixed(4) }}</span>
                </div>
              }
              @if (!formControl?.value || (!formControl?.value.lat && !formControl?.value.lng && !formControl?.value.address)) {
                <div class="no-location">
                  <mat-icon>location_off</mat-icon>
                  <span>No location set</span>
                </div>
              }
            </div>
          }
          
          <!-- Edit Mode - Location Picker -->
          @if (!readonly) {
            <div class="location-edit">
              <app-location-picker
                [initialCoordinates]="formControl?.value"
                [height]="'250px'"
                [showCoordinateInputs]="false"
                [showAddressSearch]="true"
                [allowMapClick]="true"
                (locationSelected)="onLocationSelected($event)"
                (locationCleared)="onLocationCleared()">
              </app-location-picker>
            </div>
          }
          
          @if (formControl?.invalid && formControl?.touched) {
            <div class="field-error">
              {{ getErrorMessage() }}
            </div>
          }
        </div>
      }

      
      <!-- Entity Association Field -->
      @if (isEntity()) {
        <div class="entity-field">
          <div class="field-label">
            {{ field.name }}
            @if (field.required) {
              <span class="required-indicator">*</span>
            }
          </div>
          
          <!-- Selected Entities Display -->
          @if (selectedEntities && selectedEntities.length > 0) {
            <div class="selected-entities">
              @for (entity of selectedEntities; track entity.id) {
                <div class="entity-chip">
                  <span class="entity-name">{{ entity.name }}</span>
                  @if (entity.subtitle) {
                    <span class="entity-subtitle">{{ entity.subtitle }}</span>
                  }
                  <button 
                    type="button"
                    class="remove-entity"
                    (click)="removeEntity(entity)"
                    title="Remove">
                    <mat-icon [icon]="'close'"></mat-icon>
                  </button>
                </div>
              }
            </div>
          }
          
          <!-- Add Entity Interface -->
          <div class="add-entity">
            <div class="search-container">
              <input 
                type="text"
                class="entity-search"
                [(ngModel)]="entitySearchTerm"
                [ngModelOptions]="{standalone: true}"
                (input)="onEntitySearch($event)"
                (focus)="onEntityFocus()"
                (blur)="hideEntitySuggestions()"
                placeholder="Search {{ getEntityTypeName() }}..."
                [disabled]="!field.entityConfig?.allowMultiple && selectedEntities && selectedEntities.length > 0">
              
              <!-- Search Results Dropdown -->
              @if (showEntitySuggestions && filteredEntities && filteredEntities.length > 0) {
                <div class="entity-suggestions">
                  @for (item of filteredEntities; track item.id) {
                    <div class="entity-suggestion"
                         (mousedown)="selectEntity(item)">
                      <div class="suggestion-content">
                        <div class="suggestion-name">{{ item.name }}</div>
                        @if (item.subtitle) {
                          <div class="suggestion-subtitle">{{ item.subtitle }}</div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
              
              @if (showEntitySuggestions && entitySearchTerm && filteredEntities && filteredEntities.length === 0) {
                <div class="entity-suggestions">
                  <div class="no-results">No matching {{ getEntityTypeName() }} found</div>
                </div>
              }
            </div>
          </div>
          
          @if (formControl?.invalid && formControl?.touched) {
            <div class="field-error">
              <mat-icon [icon]="'error'"></mat-icon>
              {{ getErrorMessage() }}
            </div>
          }
        </div>
      }

    </div>
  }
</div>