@if (!isLoading) {
  <app-page-layout
    [title]="title"
    [showBackButton]="true"
    [actions]="pageActions()"
    (backClick)="onBackClick()">
    
    <!-- Main Content Layout -->
  <div class="content-layout">
    <!-- Image Section -->
    <div class="image-section">
      <!-- Image Gallery -->
      <div class="image-gallery-container">
        <app-item-image-gallery
          [images]="wallItem.images || []"
          [showControls]="editing"
          [maxImages]="10"
          (imageAdded)="onImageAdded(wallItem)"
          (imageEdited)="onImageEdited($event, wallItem)"
          (imageDeleted)="onImageDeleted($event, wallItem)"
          (primaryImageChanged)="onPrimaryImageChanged($event, wallItem)">
        </app-item-image-gallery>
      </div>
      
      <!-- Image Upload -->
      @if (editing) {
        <div class="image-upload">
        <input 
          #imageInput
          type="file" 
          multiple 
          accept="image/*"
          (change)="onImageSelected($event)"
          style="display: none;">
        
        <button 
          mat-outlined-button 
          (click)="imageInput.click()"
          class="upload-button">
          <mat-icon>add_photo_alternate</mat-icon>
          Add Images
        </button>
        </div>
      }
    </div>

    <!-- Form Section -->
    <div class="form-section">
      @if (objectType) {
        <!-- Tab Groups -->
        <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="item-tabs">
          
          <!-- Details Tab -->
          <mat-tab label="Details">
            <form [formGroup]="itemForm" class="item-form">
              
              <!-- Field Groups using Accordion -->
              <mat-accordion multi="false">
          
          <!-- Basic Information Panel -->
          <mat-expansion-panel 
            [expanded]="currentPanelIndex === 0"
            (opened)="currentPanelIndex = 0"
            (closed)="currentPanelIndex = -1">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>info</mat-icon>
                Basic Information
              </mat-panel-title>
            </mat-expansion-panel-header>
            
            <div class="field-grid">
              @for (field of getBasicFields(); track field.id) {
                <app-dynamic-field-renderer
                  [field]="field"
                  [formGroup]="itemForm"
                  [readonly]="!editing"
                  [value]="wallItem.fieldData[field.id]"
                  [wall]="wall">
                </app-dynamic-field-renderer>
              }
            </div>
          </mat-expansion-panel>

          <!-- Location Panel (if has location field) -->
          @if (getLocationFields().length > 0) {
            <mat-expansion-panel 
              [expanded]="currentPanelIndex === 1"
              (opened)="currentPanelIndex = 1"
              (closed)="currentPanelIndex = -1">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>place</mat-icon>
                Location
              </mat-panel-title>
            </mat-expansion-panel-header>
            
            <div class="location-section">
              <div class="field-grid">
                @for (field of getLocationFields(); track field.id) {
                  <app-dynamic-field-renderer
                    [field]="field"
                    [formGroup]="itemForm"
                    [readonly]="!editing"
                    [value]="wallItem.fieldData[field.id]"
                    [wall]="wall">
                  </app-dynamic-field-renderer>
                }
              </div>
            </div>
            </mat-expansion-panel>
          }

          <!-- Custom Fields Panel -->
          @if (getCustomFields().length > 0) {
            <mat-expansion-panel 
              [expanded]="currentPanelIndex === 2"
              (opened)="currentPanelIndex = 2"
              (closed)="currentPanelIndex = -1">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>tune</mat-icon>
                Additional Information
              </mat-panel-title>
            </mat-expansion-panel-header>
            
            <div class="field-grid">
              @for (field of getCustomFields(); track field.id) {
                <app-dynamic-field-renderer
                  [field]="field"
                  [formGroup]="itemForm"
                  [readonly]="!editing"
                  [value]="wallItem.fieldData[field.id]"
                  [wall]="wall">
                </app-dynamic-field-renderer>
              }
            </div>
            </mat-expansion-panel>
          }

          <!-- Relationships Panel (Future Enhancement) -->
          @if (false) {
            <mat-expansion-panel 
              [expanded]="currentPanelIndex === 3"
              (opened)="currentPanelIndex = 3"
              (closed)="currentPanelIndex = -1">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>link</mat-icon>
                Relationships
              </mat-panel-title>
            </mat-expansion-panel-header>
            
            <div class="relationships-section">
              <!-- TODO: Implement relationship management -->
              <p>Relationship management coming soon...</p>
            </div>
            </mat-expansion-panel>
          }

              </mat-accordion>
            </form>
          </mat-tab>
          
          <!-- Related Items Tab (only show for existing items with relationships) -->
          @if (!isNewItem && hasRelatedItems()) {
            <mat-tab label="Related Items">
              <div class="related-items-section">
                @if (loadingRelatedItems) {
                  <app-loading-state 
                    type="spinner" 
                    message="Loading related items..."
                    [spinnerSize]="40">
                  </app-loading-state>
                } @else {
                  
                  @for (relatedType of getRelatedObjectTypes(); track relatedType.objectType.id) {
                    <div class="related-type-section">
                      <h3 class="related-type-title">
                        <mat-icon [style.color]="relatedType.objectType.color">{{ relatedType.objectType.icon || 'circle' }}</mat-icon>
                        {{ relatedType.objectType.name }}
                        <span class="item-count">({{ getRelatedItemsForType(relatedType.objectType.id).length }})</span>
                      </h3>
                      
                      @if (getRelatedItemsForType(relatedType.objectType.id).length > 0) {
                        <div class="related-items-grid">
                          @for (item of getRelatedItemsForType(relatedType.objectType.id); track item.id) {
                            <div class="related-item-card" (click)="navigateToRelatedItem(item)">
                              <div class="related-item-header">
                                <mat-icon [style.color]="relatedType.objectType.color">{{ relatedType.objectType.icon || 'circle' }}</mat-icon>
                                <h4>{{ getItemDisplayName(item) }}</h4>
                              </div>
                              <p class="related-item-summary">
                                {{ getItemSummary(item) }}
                              </p>
                            </div>
                          }
                        </div>
                      } @else {
                        <p class="no-related-items">No {{ relatedType.objectType.name.toLowerCase() }} are linked to this {{ objectType?.name?.toLowerCase() || 'item' }}.</p>
                      }
                    </div>
                  }
                  
                  @if (getRelatedObjectTypes().length === 0) {
                    <div class="no-relationships">
                      <mat-icon>link_off</mat-icon>
                      <p>No related items found for this {{ objectType?.name?.toLowerCase() || 'item' }}.</p>
                    </div>
                  }
                  
                }
              </div>
            </mat-tab>
          }
          
        </mat-tab-group>
      }
    </div>
  </div>

  <!-- Metadata Section (View Mode Only) -->
  @if (!editing && !isNewItem) {
    <div class="metadata-section">
    <mat-card class="metadata-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info_outline</mat-icon>
          Item Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metadata-grid">
          <div class="metadata-item">
            <strong>Object Type:</strong>
            <span>{{ objectType?.name }}</span>
          </div>
          <div class="metadata-item">
            <strong>Created:</strong>
            <span>{{ wallItem.createdAt | date:'medium' }}</span>
          </div>
          <div class="metadata-item">
            <strong>Updated:</strong>
            <span>{{ wallItem.updatedAt | date:'medium' }}</span>
          </div>
          @if (wallItem.tags && wallItem.tags.length > 0) {
            <div class="metadata-item">
              <strong>Tags:</strong>
              <span>{{ wallItem.tags.join(', ') }}</span>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
    </div>
  }
  
  </app-page-layout>
}

<!-- Loading State -->
@if (isLoading) {
  <app-loading-state
    type="spinner"
    message="Loading item..."
    [spinnerSize]="60">
  </app-loading-state>
}