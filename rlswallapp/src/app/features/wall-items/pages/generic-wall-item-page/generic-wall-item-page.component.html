@if (!isLoading) {
  <div class="generic-wall-item-page">
    
    <!-- Integrated Header with Tabs -->
    <div class="page-header-with-tabs">
      <div class="header-content">
        <div class="header-left">
          <button 
            type="button"
            class="back-button"
            (click)="onBackClick()"
            title="Go back">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <div class="header-info">
            <h1 class="page-title">{{ title }}</h1>
          </div>
        </div>
        
        <div class="header-actions">
          @for (action of pageActions(); track action.label) {
            <app-themed-button
              [variant]="action.variant || 'raised'"
              [color]="action.color || 'primary'"
              [icon]="action.icon"
              [disabled]="action.disabled || false"
              [pill]="true"
              [label]="action.label"
              [height]="'48px'"
              class="header-action-button"
              (buttonClick)="action.action()">
            </app-themed-button>
          }
        </div>
      </div>
    </div>

    <!-- Main Content Layout -->
    <div class="content-layout">
      <!-- Image Section -->
      <div class="image-section">
        <!-- Image Gallery -->
        <div class="image-gallery-container">
          <app-item-image-gallery
            [images]="wallItem.images || []"
            [showControls]="editing"
            [maxImages]="10"
            (imageAdded)="onImageAdded(wallItem)"
            (imageEdited)="onImageEdited($event, wallItem)"
            (imageDeleted)="onImageDeleted($event, wallItem)"
            (primaryImageChanged)="onPrimaryImageChanged($event, wallItem)">
          </app-item-image-gallery>
        </div>
        
        <!-- Image Upload -->
        @if (editing) {
          <div class="image-upload">
          <input 
            #imageInput
            type="file" 
            multiple 
            accept="image/*"
            (change)="onImageSelected($event)"
            style="display: none;">
          
          <button 
            mat-outlined-button 
            (click)="imageInput.click()"
            class="upload-button">
            <mat-icon>add_photo_alternate</mat-icon>
            Add Images
          </button>
          </div>
        }
      </div>

      <!-- Form Section with Integrated Tabs -->
      <div class="form-section">
        @if (objectType) {
          <!-- Tab Groups -->
          <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="item-tabs">
          
          <!-- Details Tab -->
          <mat-tab label="Details">
            <form [formGroup]="itemForm" class="item-form">
              
              <!-- Field Groups using Accordion -->
              <mat-accordion multi="false">
          
          <!-- Basic Information Panel -->
          <mat-expansion-panel 
            [expanded]="currentPanelIndex === 0"
            (opened)="currentPanelIndex = 0"
            (closed)="currentPanelIndex = -1">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>info</mat-icon>
                Basic Information
              </mat-panel-title>
            </mat-expansion-panel-header>
            
            <div class="field-grid">
              @for (field of getBasicFields(); track field.id) {
                <app-dynamic-field-renderer
                  [field]="field"
                  [formGroup]="itemForm"
                  [readonly]="!editing"
                  [value]="wallItem.fieldData[field.id]"
                  [wall]="wall">
                </app-dynamic-field-renderer>
              }
            </div>
          </mat-expansion-panel>

          <!-- Location Panel (if has location field) -->
          @if (getLocationFields().length > 0) {
            <mat-expansion-panel 
              [expanded]="currentPanelIndex === 1"
              (opened)="currentPanelIndex = 1"
              (closed)="currentPanelIndex = -1">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>place</mat-icon>
                Location
              </mat-panel-title>
            </mat-expansion-panel-header>
            
            <div class="location-section">
              <div class="field-grid">
                @for (field of getLocationFields(); track field.id) {
                  <app-dynamic-field-renderer
                    [field]="field"
                    [formGroup]="itemForm"
                    [readonly]="!editing"
                    [value]="wallItem.fieldData[field.id]"
                    [wall]="wall">
                  </app-dynamic-field-renderer>
                }
              </div>
            </div>
            </mat-expansion-panel>
          }

          <!-- Custom Fields Panel -->
          @if (getCustomFields().length > 0) {
            <mat-expansion-panel 
              [expanded]="currentPanelIndex === 2"
              (opened)="currentPanelIndex = 2"
              (closed)="currentPanelIndex = -1">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>tune</mat-icon>
                Additional Information
              </mat-panel-title>
            </mat-expansion-panel-header>
            
            <div class="field-grid">
              @for (field of getCustomFields(); track field.id) {
                <app-dynamic-field-renderer
                  [field]="field"
                  [formGroup]="itemForm"
                  [readonly]="!editing"
                  [value]="wallItem.fieldData[field.id]"
                  [wall]="wall">
                </app-dynamic-field-renderer>
              }
            </div>
            </mat-expansion-panel>
          }

          <!-- Relationships Panel (Future Enhancement) -->
          @if (false) {
            <mat-expansion-panel 
              [expanded]="currentPanelIndex === 3"
              (opened)="currentPanelIndex = 3"
              (closed)="currentPanelIndex = -1">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>link</mat-icon>
                Relationships
              </mat-panel-title>
            </mat-expansion-panel-header>
            
            <div class="relationships-section">
              <!-- TODO: Implement relationship management -->
              <p>Relationship management coming soon...</p>
            </div>
            </mat-expansion-panel>
          }

              </mat-accordion>
            </form>
          </mat-tab>
          
          <!-- Individual tabs for each related entity type -->
          @if (!isNewItem && hasRelatedItems()) {
            @for (relatedType of getRelatedObjectTypes(); track relatedType.objectType.id) {
              <mat-tab [label]="getTabLabelForEntityType(relatedType.objectType)">
                <div class="related-items-section">
                  @if (loadingRelatedItems) {
                    <app-loading-state 
                      type="spinner" 
                      message="Loading {{ relatedType.objectType.name.toLowerCase() }}..."
                      [spinnerSize]="40">
                    </app-loading-state>
                  } @else {
                    @if (getRelatedItemsForType(relatedType.objectType.id).length > 0) {
                      <app-wall-items-grid
                        [items]="getRelatedItemsForType(relatedType.objectType.id)"
                        [preset]="relatedType.objectType"
                        [viewMode]="'grid'"
                        [isSelectionMode]="false"
                        [selectedItems]="[]"
                        (viewItem)="navigateToRelatedItem($event)"
                        (editItem)="navigateToRelatedItem($event)">
                      </app-wall-items-grid>
                    } @else {
                      <div class="no-related-items">
                        <mat-icon [style.color]="relatedType.objectType.color">{{ relatedType.objectType.icon || 'circle' }}</mat-icon>
                        <p>No {{ relatedType.objectType.name.toLowerCase() }} are linked to this {{ objectType?.name?.toLowerCase() || 'item' }}.</p>
                      </div>
                    }
                    
                  }
                </div>
              </mat-tab>
            }
          }
          
        </mat-tab-group>
      }
    </div>
    </div>

    <!-- Metadata Section (View Mode Only) -->
  @if (!editing && !isNewItem) {
    <div class="metadata-section">
    <mat-card class="metadata-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info_outline</mat-icon>
          Item Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metadata-grid">
          <div class="metadata-item">
            <strong>Object Type:</strong>
            <span>{{ objectType?.name }}</span>
          </div>
          <div class="metadata-item">
            <strong>Created:</strong>
            <span>{{ wallItem.createdAt | date:'medium' }}</span>
          </div>
          <div class="metadata-item">
            <strong>Updated:</strong>
            <span>{{ wallItem.updatedAt | date:'medium' }}</span>
          </div>
          @if (wallItem.tags && wallItem.tags.length > 0) {
            <div class="metadata-item">
              <strong>Tags:</strong>
              <span>{{ wallItem.tags.join(', ') }}</span>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
    </div>
  }
  
  </div>
}

<!-- Loading State -->
@if (isLoading) {
  <app-loading-state
    type="spinner"
    message="Loading item..."
    [spinnerSize]="60">
  </app-loading-state>
}